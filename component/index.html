<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Component</title>
  <style>
    body {font-family: PingFangSC-Light;}
  </style>
</head>
<body>
  <div id="demo"></div>

  <script src="/libs/jquery.min.js"></script>
  <script src="./component.js"></script>
  <script>
    const components = {
      listItems: {}
    }

    components.demo = new Component({
      name: 'components.demo',
      selector: '#demo',
      render () {
        return `
          <div>
            <button onClick="${this.name}.add()">Add</button>
            <button onClick="${this.name}.remove()">Remove</button>
          </div>
          ${Component.sub(components.list, this)}
        `
      },
      created () {
        console.log('demo created')
      },
      mounted () {
        console.log('demo mounted')
      },
      updated () {
        console.log('demo updated')
      },
      methods: {
        add () {
          const {list} = components.list.data
          list.push(`Item${list.length + 1}`)
          components.list.setData({list})
        },
        remove () {
          const {list} = components.list.data
          list.pop()
          components.list.setData({list})
        }
      }
    })

    components.list = new Component({
      name: 'components.list',
      data () {
        const list = []
        for (let i = 0; i < 2; i++) {
          list.push(`Item${i + 1}`)
        }
        return {list}
      },
      render () {
        const {list} = this.data
        Component.dispatchInstances(
          list,
          listItemFactory,
          'components.listItems'
        )
        return `<ol>
          ${list.map(name => {
            // return components.listItem({name})
            return Component.sub(components.listItems[name], this, {name})
          }).join('')}
        </ol>`
      },
      created () {
        console.log('list created')
      },
      mounted () {
        console.log('list mounted')
      },
      updated () {
        console.log('list updated')
      }
    })

    components.listItem = data => {
      return `<li>${data.name}</li>`
    }

    function listItemFactory (options = {}) {
      return {
        name: options.name,
        data: {
          name: null,
          count: 0
        },
        render () {
          const {name, count} = this.data
          return `<li>
            ${name}.
            count:${count}
            <button onClick="${this.name}.increase()">increase</button>
          </li>`
        },
        created () {
          console.log(`listItem created, name: ${this.data.name}`)
        },
        mounted () {
          console.log(`listItem mounted, name: ${this.data.name}`)
        },
        updated () {
          console.log(`listItem updated, name: ${this.data.name}`)
        },
        methods: {
          increase () {
            let {count} = this.data
            count++
            this.setData({count})
          }
        }
      }
    }
  </script>
</body>
</html>
